<?php

declare(strict_types=1);

namespace App\Rules;

use App\Models\User;
use Closure;
use Illuminate\Contracts\Validation\ValidationRule;

final readonly class Username implements ValidationRule
{
    /**
     * Create a new rule instance.
     *
     * @param  array<int, string>  $reserved
     */
    public function __construct(
        private ?User $user = null,
        private array $reserved = [
            '0',
            'about',
            'access',
            'account',
            'accounts',
            'activate',
            'activities',
            'activity',
            'ad',
            'add',
            'address',
            'adm',
            'admin',
            'administration',
            'administrator',
            'ads',
            'adult',
            'advertising',
            'affiliate',
            'affiliates',
            'ajax',
            'all',
            'alpha',
            'analysis',
            'analytics',
            'android',
            'anon',
            'anonymous',
            'api',
            'app',
            'apps',
            'archive',
            'archives',
            'article',
            'asct',
            'asset',
            'atom',
            'auth',
            'authentication',
            'avatar',
            'backup',
            'balancer-manager',
            'banner',
            'banners',
            'beta',
            'billing',
            'bin',
            'blog',
            'blogs',
            'board',
            'book',
            'bookmark',
            'bot',
            'bots',
            'bug',
            'business',
            'cache',
            'cadastro',
            'calendar',
            'call',
            'campaign',
            'cancel',
            'captcha',
            'career',
            'careers',
            'cart',
            'categories',
            'category',
            'cgi',
            'cgi-bin',
            'changelog',
            'chat',
            'check',
            'checking',
            'checkout',
            'client',
            'cliente',
            'clients',
            'code',
            'codereview',
            'comercial',
            'comment',
            'comments',
            'communities',
            'community',
            'company',
            'compare',
            'compras',
            'config',
            'configuration',
            'connect',
            'contact',
            'contact-us',
            'contact_us',
            'contactus',
            'contest',
            'contribute',
            'corp',
            'create',
            'css',
            'dashboard',
            'data',
            'db',
            'default',
            'delete',
            'demo',
            'design',
            'designer',
            'destroy',
            'dev',
            'devel',
            'developer',
            'developers',
            'diagram',
            'diary',
            'dict',
            'dictionary',
            'die',
            'dir',
            'direct_messages',
            'directory',
            'dist',
            'doc',
            'docs',
            'documentation',
            'domain',
            'download',
            'downloads',
            'ecommerce',
            'edit',
            'editor',
            'edu',
            'education',
            'email',
            'employment',
            'empty',
            'end',
            'enterprise',
            'entries',
            'entry',
            'error',
            'errors',
            'eval',
            'event',
            'exit',
            'explore',
            'facebook',
            'faq',
            'favorite',
            'favorites',
            'feature',
            'features',
            'feed',
            'feedback',
            'feeds',
            'file',
            'files',
            'first',
            'flash',
            'fleet',
            'fleets',
            'flog',
            'follow',
            'followers',
            'following',
            'forgot',
            'form',
            'forum',
            'forums',
            'founder',
            'free',
            'friend',
            'friends',
            'ftp',
            'gadget',
            'gadgets',
            'game',
            'games',
            'get',
            'ghost',
            'gift',
            'gifts',
            'gist',
            'github',
            'graph',
            'group',
            'groups',
            'guest',
            'guests',
            'help',
            'home',
            'about',
            'homepage',
            'host',
            'hosting',
            'hostmaster',
            'hostname',
            'howto',
            'hpg',
            'html',
            'http',
            'httpd',
            'https',
            'i',
            'iamges',
            'icon',
            'icons',
            'id',
            'idea',
            'ideas',
            'image',
            'images',
            'imap',
            'img',
            'index',
            'indice',
            'info',
            'information',
            'inquiry',
            'instagram',
            'intranet',
            'invitations',
            'invite',
            'ipad',
            'iphone',
            'irc',
            'is',
            'issue',
            'issues',
            'it',
            'item',
            'items',
            'java',
            'javascript',
            'job',
            'jobs',
            'join',
            'js',
            'json',
            'jump',
            'knowledgebase',
            'language',
            'languages',
            'last',
            'legal',
            'license',
            'link',
            'links',
            'linux',
            'list',
            'lists',
            'log',
            'log-in',
            'log-out',
            'log_in',
            'log_out',
            'login',
            'logout',
            'logs',
            'm',
            'mac',
            'mail',
            'mail1',
            'mail2',
            'mail3',
            'mail4',
            'mail5',
            'mailer',
            'master',
            'me',
            'media',
            'member',
            'members',
            'mis',
            'moderator',
            'movie',
            'movies',
            'mysql',
            'name',
            'nickname',
            'null',
            'oauth',
            'oauth_clients',
            'php',
            'phpmyadmin',
            'phppgadmin',
            'phpredisadmin',
            'popcorn',
            'post',
            'show',
            'sign-in',
            'sign-up',
            'sign_in',
            'sign_up',
            'signin',
            'signout',
            'signup',
            'site',
            'sitemap',
            'sites',
            'sql',
            'src',
            'ssh',
            'ssl',
            'ssladmin',
            'ssladministrator',
            'sslwebmaster',
            'staff',
            'stage',
            'staging',
            'status',
            'store',
            'system',
            'tag',
            'terms',
            'terms-of-service',
            'terms_of_service',
            'termsofservice',
            'test',
            'test1',
            'test2',
            'test3',
            'teste',
            'testing',
            'tests',
            'tmp',
            'web',
            'webhook',
            'webhooks',
            'webmail',
            'webmaster',
            'website',
            'websites',
            'ww',
            'wws',
            'www',
            'www1',
            'www2',
            'www3',
            'www4',
            'www5',
            'www6',
            'www7',
            'wwws',
            'wwww',
            'xfn',
            'xml',
            'xmpp',
            'xpg',
            'xxx',
            'yaml',
            'year',
            'yml',
            'you',
            'yourdomain',
            'yourname',
            'yoursite',
            'yourusername',
        ]
    ) {
        //
    }

    /**
     * Run the validation rule.
     *
     * @param  Closure(string): \Illuminate\Translation\PotentiallyTranslatedString  $fail
     */
    public function validate(string $attribute, mixed $value, Closure $fail): void
    {
        $value = type($value)->asString();

        if (preg_match('/[A-Za-z].*[A-Za-z]/', $value) === 0) {
            $fail('The :attribute must contain at least 2 letters.');

            return;
        }

        if (preg_match('/^\w+$/', $value) === 0) {
            $fail('The :attribute may only contain letters, numbers, and underscores.');

            return;
        }

        if (in_array($value, $this->reserved, true)) {
            $fail('The :attribute is reserved.');

            return;
        }

        $query = User::whereRaw('lower(username) = ?', [mb_strtolower($value)]);

        if ($this->user instanceof User) {
            $query->where('id', '!=', $this->user->id);
        }

        if ($query->exists()) {
            $fail('The :attribute has already been taken.');
        }
    }
}
